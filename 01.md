scbr_backend   | 2025-12-14 10:38:30,408 - app.api.endpoints - INFO - [API] Received chat request for Session: sess_1765708709155_ojvdmnuc8
scbr_backend   | 2025-12-14 10:38:30,410 - app.core.orchestrator - INFO - Lock acquired for session sess_1765708709155_ojvdmnuc8
scbr_backend   | 2025-12-14 10:38:45,641 - httpx - INFO - HTTP Request: POST https://integrate.api.nvidia.com/v1/chat/completions "HTTP/1.1 200 OK"
scbr_backend   | 2025-12-14 10:38:45,643 - app.core.orchestrator - INFO - [Orchestrator] Translation complete. Missing info: ['tongue', 'pulse']
scbr_backend   | 2025-12-14 10:38:46,769 - httpx - INFO - HTTP Request: POST https://integrate.api.nvidia.com/v1/embeddings "HTTP/1.1 200 OK"
scbr_backend   | 2025-12-14 10:38:46,998 - app.core.orchestrator - INFO - [Orchestrator] Max similarity: 0.8084754943847656 (Query: 這兩天突然怕冷、流鼻水 (Acute)。但我平時就很容易累，大便都散散的，吃冷的東西就拉肚子...)
scbr_backend   | 2025-12-14 10:38:46,998 - app.services.visualization - INFO - [Viz] Raw 8-Principles Data: {'yin': 5, 'yang': 4, 'biao': 7, 'li': 5, 'han': 8, 're': 2, 'xu': 7, 'shi': 3}
scbr_backend   | 2025-12-14 10:38:46,999 - app.core.orchestrator - INFO - Path A Selected (Similarity: 0.8085)
scbr_backend   | 2025-12-14 10:39:03,938 - httpx - INFO - HTTP Request: POST https://integrate.api.nvidia.com/v1/chat/completions "HTTP/1.1 200 OK"
scbr_backend   | 2025-12-14 10:39:03,939 - app.core.orchestrator - WARNING - [Orchestrator] Path A rejected the case (Procrustean Gap). Falling back to Path B.
scbr_backend   | 2025-12-14 10:39:03,940 - app.core.orchestrator - INFO - Path B Selected. Max sim: 0.8084754943847656
scbr_backend   | 2025-12-14 10:39:04,333 - httpx - INFO - HTTP Request: POST https://integrate.api.nvidia.com/v1/embeddings "HTTP/1.1 200 OK"
scbr_backend   | 2025-12-14 10:39:23,303 - httpx - INFO - HTTP Request: POST https://integrate.api.nvidia.com/v1/chat/completions "HTTP/1.1 200 OK"
scbr_backend   | 2025-12-14 10:39:23,304 - app.agents.reasoning - ERROR - Reasoning Agent Error: 1 validation error for FollowUpQuestion
scbr_backend   | question_text
scbr_backend   |   Field required [type=missing, input_value={'required': True, 'curre...受', '正常溫度']}, input_type=dict]
scbr_backend   |     For further information visit https://errors.pydantic.dev/2.12/v/missing
scbr_backend   | Raw Output: <think>
scbr_backend   | 好的，我现在需要处理这个病例，按照SCBR系统的协议进行诊断。首先，用户提供的信息包括病患特征、参考规则库和上一轮诊断参考。根据输入，病人有急性畏寒、流涕，平时容易累，大便稀，吃冷的东西就拉肚子。八纲评分显示寒分较高，表证评分7，虚分7，实分3。没有舌象和脉象信息。
scbr_backend   |
scbr_backend   | 首先，进入Phase 1的证据溯源。根据标准化特征，患者有畏寒、流涕，这属于表证的寒证特征。同时，平时的疲劳、大便稀、食冷下痢可能指向脾虚或阳虚。八纲评分中的寒分8，表分7，虚分7，实分3，支持表寒虚证的可能性。
scbr_backend   |
scbr_backend   | 接下来是逻辑闸的互斥锁检查。患者没有出汗的主诉，所以根据规则[无汗] LOCK [阴虚盗汗]和[table虚自汗]，排除阴虚或气虚自汗的可能。因此，表证的寒证更可能。
scbr_backend   |
scbr_backend   | 然后是臟腑辯論，患者的症状主要集中在表证寒证，但平时的疲劳和大便稀可能涉及脾或阳气不足。需要考虑是否为表寒内虚的复合证。
scbr_backend   |
scbr_backend   | 进入Phase 2的推理执行。Step 1八纲辩论，提案者认为是表寒实证，审查者检查互斥锁，确认没有互斥的情况，且寒分高，所以支持表寒。Step 2臟腑辩论，提案者定位于肺或脾，但根据症状，流涕和畏寒更可能是表证，脾虚可能作为素体。Step 3鑑別診斷，综合考虑，可能为表寒证，但需要考虑素体阳虚的影响，导致本虚标实的情况。
scbr_backend   |
scbr_backend   | 在红白脸对抗中，提案者提出风寒束肺证，但审查者需要检查是否有必要条件。风寒束肺通常有咳嗽、痰白，但患者没有咳嗽的主诉，所以可能不符合。审查者可能提出寒饮伏肺的可能性，但同样需要更多证据。因此，可能需要进一步询问症状，如躺下是否加重咳嗽。
scbr_backend   |
scbr_backend   | 治疗原则方面，应该是解表散寒，健脾止泻，但需要结合虚证的处理，比如温中益气。由于不能具体开药，只能给出治则。
scbr_backend   |
scbr_backend   | 最后，输出JSON时，需要确保符合格式，包括诊断列表、证据追踪、治疗原则和后续问题。后续问题可能是关于是否有咳嗽或躺下加重，以区分寒饮和表寒证。
scbr_backend   | </think>
scbr_backend   |
scbr_backend   | <json>
scbr_backend   | {
scbr_backend   |     "response_type": "DEFINITIVE",
scbr_backend   |     "diagnosis_list": [
scbr_backend   |         {
scbr_backend   |             "rank": 1,
scbr_backend   |             "disease_name": "表寒證 (寒邪束表)",
scbr_backend   |             "confidence": 0.92,
scbr_backend   |             "condition": "通過互斥鎖驗證；符合所有必要條件（惡寒+表證特徵）；八綱寒分8最高，符合客觀評分。"
scbr_backend   |         },
scbr_backend   |         {
scbr_backend   |             "rank": 2,
scbr_backend   |             "disease_name": "陽虛內傷寒證 (本虛標實) (脾陽虛)",
scbr_backend   |             "confidence": 0.75,
scbr_backend   |             "condition": "審查者警告: 缺失必要條件[脈沉遲]，但平時疲勞、大便稀提示可能存在陽虛素體，需進一步確認。"
scbr_backend   |         },
scbr_backend   |         {
scbr_backend   |             "rank": 3,
scbr_backend   |             "disease_name": "寒濕下注證 (下痢主型)",
scbr_backend   |             "confidence": 0.3,
scbr_backend   |             "condition": "審查者保留: 食冷下痢可能為寒濕下注，但缺乏明確濕象（如苔膩）與脈象支持。"
scbr_backend   |         }
scbr_backend   |     ],
scbr_backend   |     "evidence_trace": "1. 八綱裁決: 根據Rule 1（客觀>主觀），八綱寒分8最高，優先判斷為表寒證；2. 互斥鎖檢查: 無汗現象排除陰虛/氣虛汗證；3. 最終鑑別: 綜合急性畏寒+流涕（表證特徵）與慢性疲勞/大便稀（虛證特徵），形成本虛標實的複合病機，但現階段以表寒證為主。後續需釐清陽虛程度。",
scbr_backend   |     "treatment_principle": "解表散寒為主，溫中健脾為輔。若確認陽虛加溫陽劑；若寒濕明顯加芒硝等化濕。",
scbr_backend   |     "formatted_report": "【診斷結構】\n- 八綱分析: 表寒（8）＞虛（7）＞陽（4）\n- 病機推導: 急性風寒外感束表（表證），平時陽虛（脾陽）導致寒邪易入，形成本虛標實之複合病機\n- 治療策略: 解表散寒（風寒）+溫中健脾（陽虛）+止泻（寒濕下注）\n【風險提示】: 若出現脈沉遲或四肢冰涼，需升級為陽虛證型。",
scbr_backend   |     "follow_up_question": {
scbr_backend   |         "required": true,
scbr_backend   |         "current_top_hypothesis": "表寒證",
scbr_backend   |         "main_competitor": "陽虛內傷寒證",
scbr_backend   |         "discriminating_question": "請問平時四肢溫度如何？（尤其冬季）",
scbr_backend   |         "purpose": "區分單純表寒與陽虛導致之寒證",
scbr_backend   |         "options": ["常年四肢冰涼", "冬季稍涼但可耐受", "正常溫度"]
scbr_backend   |     }
scbr_backend   | }
scbr_backend   | </json>
scbr_backend   | 2025-12-14 10:39:23,305 - app.core.orchestrator - INFO - Pipeline finished for session sess_1765708709155_ojvdmnuc8. Path: PATH_B
scbr_backend   | 2025-12-14 10:39:23,305 - monitoring - INFO - [METRIC] Type=SemanticConfidence | Session=sess_1765708709155_ojvdmnuc8 | Value=0.0000
scbr_backend   | 2025-12-14 10:39:23,306 - monitoring - INFO - [METRIC] Type=PathSimilarity | Session=sess_1765708709155_ojvdmnuc8 | Value=0.8085
scbr_backend   | 2025-12-14 10:39:23,306 - monitoring - INFO - [METRIC] Type=PathSelected | Session=sess_1765708709155_ojvdmnuc8 | Value=PATH_B
scbr_backend   | 2025-12-14 10:39:23,306 - monitoring - INFO - [METRIC] Type=TurnProcessed | Session=sess_1765708709155_ojvdmnuc8 | Timestamp=1765708763.3067389
scbr_backend   | 2025-12-14 10:39:23,307 - monitoring - INFO - [METRIC] Type=InfoEntropy | Session=sess_1765708709155_ojvdmnuc8 | Value=0.0000
scbr_backend   | 2025-12-14 10:39:23,307 - monitoring - INFO - [METRIC] Type=Latency | Session=sess_1765708709155_ojvdmnuc8 | Endpoint=/chat | Value=52898.01ms
scbr_backend   | INFO:     172.18.0.4:51900 - "POST /api/v1/chat HTTP/1.1" 200 OK
scbr_backend   | 2025-12-14 10:39:23,308 - app.agents.summarizer - INFO - [Summarizer] Starting background summarization for Session: sess_1765708709155_ojvdmnuc8
scbr_backend   | 2025-12-14 10:39:30,408 - httpx - INFO - HTTP Request: POST https://integrate.api.nvidia.com/v1/chat/completions "HTTP/1.1 200 OK"
scbr_backend   | 2025-12-14 10:39:30,409 - app.agents.summarizer - INFO - [Summarizer] Summary updated: [起病]兩天前突發惡寒、流鼻水 (新感) -> [現況]持續恐寒、流鼻水 (ACTIVE); [素體...
scbr_backend   | 2025-12-14 10:39:30,409 - app.core.orchestrator - INFO - [Summarizer] Updated In-Memory Summary for sess_1765708709155_ojvdmnuc8